# LSTM 유량 예측 모델 결과 분석 - 600개 (02_lstm_flow_600samples.ipynb)

## 모델 설정 (초기)

| 항목 | 값 |
|------|-----|
| 데이터 | 600개 (2023-01-01, 10시간) |
| input_time | 144분 (2.4시간) |
| output_time | 10분 |
| hidden_size | 128 |
| num_layers | 1 |
| dropout | 0 |
| batch_size | 32 |
| weight_decay | 1e-5 |
| 파라미터 수 | 68,362개 |

## 데이터 현황

- 원본: 600개 (df.head(600))
- 전처리: IQR 104개 제거, 급변동 1개 제거 → 총 105개 제거 (보간 복구)
- 전처리 후 범위: [67.42, 144.76]
- Scaler 범위: [63.84, 131.73]
- Train: 312개 / Val: 67개 / Test: 68개
- 슬라이딩 윈도우: 447개 샘플

## 초기 결과

- Early Stopping: Epoch 27 (patience 10)
- Best Val Loss: 0.000875
- Test Loss: 0.021247

|  | 값 |
|--|-----|
| RMSE | 9.4627 |
| MAE | 8.7719 |
| MAPE | 7.03% |
| Bias | +8.77 (심각한 과소예측) |

### Quartile별 성능

| 구간 | MAPE | RMSE |
|------|------|------|
| Q1 (Low) | 4.67% | 5.74 |
| Q2 | 6.48% | 8.03 |
| Q3 | 9.32% | 12.28 |
| Q4 (High) | 7.56% | 10.39 |

## 문제점 분석

### 1. 심각한 과적합
Val/Test Loss 비율 = 0.000875 / 0.021247 = **24.3배**.
모델이 학습 데이터를 암기하고 일반화 실패.

### 2. 양의 편향 (Bias = +8.77)
Mean Error가 +8.77 → 모델이 체계적으로 과소예측.
원인: 시간 순서 분할로 Train/Val/Test의 데이터 분포가 다름 (비정상성).
600개(10시간) 내에서도 유량 패턴이 변화하여 분포 이동(distribution shift) 발생.

### 3. 데이터 대비 과도한 모델 복잡도
- 파라미터 68,362개 vs 학습 샘플 312개 → 파라미터/샘플 비율 219:1
- input_time 144분은 ACF 분석 결과 r=0.22 (약한 상관)으로 불필요하게 긴 입력

### 4. Quartile 불균형
Q3 MAPE 9.32% vs Q1 MAPE 4.67%로 편차가 큼. 중간~높은 유량 구간 예측이 취약.

## 개선 적용 (3가지)

### 변경 내역

| 항목 | 초기 | 개선 후 |
|------|------|---------|
| input_time | 144 | 30 |
| hidden_size | 128 | 32 |
| num_layers | 1 | 2 |
| dropout | 0 | 0.3 |
| weight_decay | 1e-5 | 1e-4 |
| 파라미터 수 | 68,362 | 13,258 |
| 슬라이딩 윈도우 | 447개 | 561개 |
| Bias 보정 | 없음 | Validation 잔차 기반 |

### 개선 후 결과

|  | 보정 전 | 보정 후 |
|--|--------|--------|
| RMSE | 4.53 | 4.16 |
| MAE | 3.63 | 3.21 |
| MAPE | 2.88% | 2.54% |
| Bias | +3.60 | +0.07 |

### 개선 효과 요약

| 지표 | 초기 → 개선 후 | 변화율 |
|------|----------------|--------|
| RMSE | 9.46 → 4.16 | -56% |
| MAE | 8.77 → 3.21 | -63% |
| MAPE | 7.03% → 2.54% | -64% |
| Bias | +8.77 → +0.07 | -99% |

## Asymmetric Loss 시도 (실패)

- AsymmetricMSELoss(alpha=0.7) 적용 → 결과 악화
- 원인: Bias가 모델 구조 문제가 아닌 데이터 비정상성(distribution shift)에서 기인
- Asymmetric Loss는 모델이 학습할 수 있는 편향에만 효과적
- 결론: MSELoss로 복원

## 종합 판단

600개(10시간) 데이터의 근본 한계:
- 데이터 부족으로 과적합 불가피 (파라미터 >> 샘플)
- 10시간 내 분포 변화로 비정상성 문제 발생
- 개선 3가지 적용으로 성능은 크게 향상(MAPE 7.03% → 2.54%)했지만,
  낮은 MAPE는 데이터 범위가 좁기(64~132) 때문이며 실제 일반화 능력은 제한적
- **데이터 증가(3개월 이상)가 필수적**이라는 결론 도출 → 131K 모델로 확장
