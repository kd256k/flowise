# LSTM 다변량 유량 예측 모델 결과 분석 (seq2seq_attn_flow_prediction.ipynb)

## 모델 설정

| 항목 | v2 | v3 (현재) |
|------|-----|-----------|
| 데이터 | 175,627개 (1년 전체) | 228,825개 (계절별 블록 샘플링) |
| 샘플링 | 순차 (시간순 전체) | 4계절 × 45일 블록 |
| input_time | 72 steps (72분) | 72 steps (72분) |
| output_time | 15 steps (15분) × 4 rolling = 1시간 | 15 steps (15분) × 4 rolling = 1시간 |
| features | 10개 (value, temperature, rainfall, humidity + 6 cyclical) | 동일 |
| hidden_size | 128 | 128 |
| num_layers | 2 | 2 |
| dropout | 0.2 | 0.2 |
| batch_size | 256 | 256 |
| patience | 7 | 5 |
| weight_decay | 1e-5 | 1e-5 |
| Gradient Clipping | max_norm=1.0 | max_norm=1.0 |
| 파라미터 수 | 204,163개 | 204,163개 |

### Feature 구성

| Feature | 정규화 | 범위 | 설명 |
|---------|--------|------|------|
| value | MinMaxScaler | [0, 1] | 유량 (예측 대상) |
| temperature | MinMaxScaler | [0, 1] | 기온 |
| rainfall | log1p → MinMaxScaler | [0, 1] | 강수량 (분포변환 후 정규화) |
| humidity | MinMaxScaler | [0, 1] | 습도 |
| time_sin, time_cos | 없음 | [0, 1] | 하루 주기 (T=1440), 0.5*sin+0.5 |
| dow_sin, dow_cos | 없음 | [0, 1] | 요일 주기 (T=7), 0.5*sin+0.5 |
| season_sin, season_cos | 없음 | [0, 1] | 계절 주기 (T=365.25), 0.5*sin+0.5 |

### Scaler 범위 (Train 기준)

| Feature | Min | Max |
|---------|-----|-----|
| value | 0.03 | 321.75 |
| temperature | -16.40 | 37.18 |
| rainfall (log1p) | 0.00 | 24.64 |
| humidity | 3.14 | 99.90 |

### 전처리 특이사항

1. **rainfall log1p 변환**: 극단값 다수 (skew=9.80) → `np.log1p(rainfall)` 적용 후 정규화
2. **cyclical features [0, 1]**: `0.5 * sin(...) + 0.5`로 범위를 [0, 1]로 조정. MinMaxScaler 미적용 (고정 범위)
3. **1분 단위**: 리샘플링 없이 원본 1분 단위 데이터 사용

---

## v3 변경사항 (Seasonal Block Sampling)

### 변경 요약 (v2 → v3)

| 항목 | v2 | v3 | 변경 이유 |
|------|-----|-----|----------|
| 데이터 샘플링 | 1년 전체 순차 | 4계절 × 45일 블록 | 계절 균등 학습 |
| Train/Val/Test 분할 | 전체 순차 분할 | **블록별 독립 분할** | 모든 split에 4계절 포함 |
| patience | 7 | 5 | v2에서 회복 없이 종료 → 불필요한 대기 제거 |
| 데이터 수 | 175,627 | 228,825 | 블록 간 겹침 없는 독립 윈도우 |

### 계절별 블록 구성

| 계절 | 기간 | 일수 |
|------|------|------|
| Winter | 2023-12-01 ~ 2024-01-14 | 45일 |
| Spring | 2023-04-01 ~ 2023-05-15 | 45일 |
| Summer | 2023-07-01 ~ 2023-08-14 | 45일 |
| Fall | 2023-10-01 ~ 2023-11-14 | 45일 |

### 분할 방식 변경

v2: 전체 데이터를 시간순으로 70/15/15 분할 → Train에 봄·여름, Test에 가을만 포함되는 편향 발생.

v3: 각 계절 블록 내에서 독립적으로 70/15/15 분할 → **모든 split(Train/Val/Test)에 4계절 균등 포함**.

---

## v3 결과

- Data: 228,825행 (4계절 블록 샘플링)
- Train/Val/Test: 블록별 독립 분할 (70/15/15)
- Early Stopping: Epoch 19 (patience 5)
- Best Val Loss: 0.000803 / Test Loss: 0.000768

### 평가 지표

| 지표 | v3 값 |
|------|-------|
| RMSE | 8.6636 |
| MAE | 5.6786 |
| MAPE | 3.97% |
| R² | 0.9757 |
| Bias | -1.0564 |

---

## EDA 성능 지표 설명

### 평가 지표 의미

| 지표 | 정식 명칭 | 의미 | 해석 기준 |
|------|----------|------|----------|
| **RMSE** | Root Mean Squared Error | 예측 오차의 제곱평균 제곱근. 큰 오차에 민감 | 낮을수록 좋음. 데이터 범위(0~322) 대비 비율로 판단 |
| **MAE** | Mean Absolute Error | 예측 오차의 절대값 평균. RMSE보다 이상치에 둔감 | 낮을수록 좋음. "평균적으로 ±N만큼 틀린다" |
| **MAPE** | Mean Absolute Percentage Error | 실제 값 대비 오차 비율(%). 스케일 독립적 | 5% 이하 = 실용 수준, 10% 이상 = 개선 필요 |
| **R²** | Coefficient of Determination | 모델이 설명하는 분산 비율. 1.0 = 완벽 | 0.95+ = 우수, 0.99+ = 탁월 |
| **Bias** | Mean Error (Actual - Predicted) | 체계적 예측 편향. 양수 = 과소예측, 음수 = 과대예측 | 0에 가까울수록 좋음 |

### RMSE vs MAE 차이

- RMSE > MAE이면 큰 오차가 간헐적으로 존재 (이상치 민감)
- v3: RMSE(8.66) - MAE(5.68) = 2.98 → 일부 구간에서 큰 오차 발생

---

## 전체 버전 성능 비교

### v1 / v2 / v3 비교

| 지표 | v1 | v2 | v3 (현재) | v2→v3 변화 |
|------|-----|-----|-----------|-----------|
| RMSE | 26.4250 | 8.4146 | 8.6636 | +0.25 (+3.0%) |
| MAE | 17.4685 | 5.4744 | 5.6786 | +0.20 (+3.7%) |
| MAPE | 10.31% | 3.35% | 3.97% | +0.62%p |
| R² | 0.7899 | 0.9787 | 0.9757 | -0.003 |
| Bias | +7.9245 | +2.1302 | **-1.0564** | 방향 전환 (과소→과대) |
| Val Loss | 0.006673 | 0.000821 | 0.000803 | -0.000018 (-2.2%) |
| Test Loss | 0.006759 | 0.000684 | 0.000768 | +0.000084 |
| Epoch | 18 | 19 | 19 | - |

### 전체 모델 이력

| 지표 | LSTM_600 | LSTM_131k | LSTM_wt v1 | LSTM_wt v2 | LSTM_wt v3 (현재) |
|------|----------|-----------|------------|------------|-------------------|
| 데이터 | 600개 (10시간) | 129,474개 (3개월) | 175,627개 (1년) | 175,627개 (1년) | 228,825개 (계절 블록) |
| Features | 1 (value) | 1 (value) | 10 (다변량) | 10 (다변량) | 10 (다변량) |
| 예측 범위 | 10분 | 10분 | 1시간 (직접) | 1시간 (rolling) | 1시간 (rolling) |
| RMSE | 4.53 | 5.31 | 26.42 | 8.41 | **8.66** |
| MAE | 3.63 | 4.17 | 17.47 | 5.47 | **5.68** |
| MAPE | 2.88% | 3.44% | 10.31% | 3.35% | **3.97%** |
| R² | - | 0.9916 | 0.7899 | 0.9787 | **0.9757** |
| Bias | +3.60 | -1.57 | +7.92 | +2.13 | **-1.06** |

### 비교 분석

v3는 v2 대비 RMSE/MAE/MAPE가 소폭 하락했으나, 이는 **의도된 trade-off**:

1. **Bias 방향 전환**: +2.13(과소예측) → -1.06(과대예측). 절대값은 50% 감소. 계절 균등 학습으로 특정 계절 편향이 완화됨
2. **Val Loss 개선**: 0.000821 → 0.000803. 학습 자체는 더 안정적
3. **MAPE 3.97%**: 실용 기준(5%) 이내 유지
4. **계절 범용성 확보**: v2는 Train에 봄·여름만, Test에 가을만 포함되어 계절 편향. v3는 모든 split에 4계절 포함

---

## 계절별 성능 분석 (Per-Season)

| 계절 | RMSE | MAE | R² | Bias | Samples |
|------|------|-----|-----|------|---------|
| Winter | 8.19 | 5.33 | 0.9751 | +0.21 | 8,892 |
| Spring | 9.10 | 5.83 | 0.9736 | -0.73 | 7,080 |
| Summer | 9.07 | 6.17 | 0.9734 | -1.89 | 9,481 |
| Fall | 8.31 | 5.38 | 0.9794 | -1.69 | 8,820 |

### 계절별 해석

- **Winter (최저 RMSE 8.19)**: 유량 변동이 적어 예측 가장 안정적. Bias +0.21로 거의 편향 없음
- **Spring (RMSE 9.10)**: 계절 전환기 유량 변동 증가. 경미한 과대예측(-0.73)
- **Summer (최고 MAE 6.17)**: 강수량 급변에 따른 유량 변동이 가장 큼. Bias -1.89로 과대예측 경향
- **Fall (최고 R² 0.9794)**: 설명력이 가장 높으나 Bias -1.69로 과대예측 존재

---

## Step-wise MAE 분석

| Step | MAE | vs Step 0 | Degradation |
|------|-----|-----------|-------------|
| 0 | 1.09 | baseline | - |
| 1 | 1.42 | +0.34 | +31.0% |
| 2 | 1.85 | +0.77 | +70.6% |
| 3 | 2.41 | +1.32 | +121.7% |
| 4 | 3.05 | +1.96 | +180.2% |
| 5 | 3.76 | +2.67 | +245.6% |
| 7 | 5.33 | +4.25 | +390.7% |
| 10 | 8.05 | +6.96 | +640.3% |
| 14 | 11.29 | +10.20 | +938.5% |

### Step-wise 해석

Step 0(1분 후) MAE=1.09 → Step 14(15분 후) MAE=11.29. **약 10배 증가**.
fc layer가 128차원 hidden state 하나로 15개 step을 동시 추정하는 구조적 한계.
→ Multi-Head Attention (Step-Query Cross-Attention) 적용 시 먼 step의 오차 감소 기대.

---

## 시간별 성능 분석 (Timetable)

### 일간 (Hourly) — 시간대별 MAE

| 구분 | MAE | 설명 |
|------|-----|------|
| Peak (06~22시) | 6.36 | 주간 활동 시간대. 유량 변동 크고 오차 높음 |
| Off-peak (23~05시) | 3.96 | 야간. 유량 안정적, 오차 낮음 |
| Worst hour | 10:00 (MAE=7.26) | 오전 피크 시간. 출근 후 수요 급증 구간 |
| Best hour | 03:00 (MAE=2.19) | 새벽. 유량 변동 최소 구간 |

```
MAE
 7 |         ██
 6 |   ██  ████████
 5 | ████  ██████████████
 4 | ██████████████████████
 3 | ████████████████████████      ██
 2 |██████████████████████████████████
   +--+--+--+--+--+--+--+--+--+--+--+--→
   00 02 04 06 08 10 12 14 16 18 20 22  Hour
        Off-peak  ←|→  Peak         ←|→ Off
```

Peak 시간대의 MAE가 Off-peak 대비 **1.6배** 높음. 유량 급변 구간(08~12시)에서 오차 집중.

### 주간 (Weekly) — 요일별 MAE

| 구분 | MAE |
|------|-----|
| Weekday (Mon-Fri) | 5.58 |
| Weekend (Sat-Sun) | 5.88 |

주말이 평일 대비 MAE +5.4% 높음. 주말 유량 패턴이 불규칙하여 예측 난이도 상승.

### 월간 (Monthly) — 월별 MAE Top 3

| 순위 | 월 | MAE | 원인 |
|------|-----|-----|------|
| 1 | Aug (8월) | 6.17 | 집중호우, 강수 급변 |
| 2 | May (5월) | 5.83 | 계절 전환기 유량 불안정 |
| 3 | Nov (11월) | 5.38 | 가을→겨울 전환 |

8월(여름 집중호우)이 가장 예측 어려운 월. rainfall log1p 변환에도 극단적 강수 이벤트의 영향이 잔존.

### 계절별 (Seasonal) — Actual vs Predicted 분포

| 계절 | Actual 평균 | Predicted 평균 | 차이 | 분포 일치도 |
|------|------------|---------------|------|------------|
| Winter | 안정적, 분산 작음 | 잘 추적 | Bias ≈ 0 | 높음 |
| Spring | 상승 추세, 변동 증가 | 약간 과대 | Bias -0.73 | 중간 |
| Summer | 고유량, 분산 최대 | 과대 경향 | Bias -1.89 | 낮음 |
| Fall | 하강 추세 | 과대 경향 | Bias -1.69 | 중간 |

Violin + Box plot 분석 결과, Summer의 분포 tail 부분에서 Predicted가 Actual을 초과하는 경향이 뚜렷함.

---

## 평가

### 긍정적 측면

1. **R² = 0.9757**: 전체 분산의 97.6% 설명. 1시간 예측 기준 실용 수준(>0.95) 달성
2. **MAPE = 3.97%**: 5% 기준 이내. 실서비스 적용 가능 수준
3. **Bias 절대값 감소**: v2(+2.13) → v3(-1.06). |Bias| 50% 감소
4. **계절 범용성**: 4계절 균등 학습으로 특정 계절 편향 해소
5. **Val Loss 개선**: 0.000821 → 0.000803. 학습 안정성 향상

### 부정적 측면

1. **MAPE 소폭 하락**: 3.35% → 3.97%. 계절 다양성 학습의 대가
2. **Step degradation 심각**: Step 14 MAE가 Step 0의 10배. fc layer 구조적 한계
3. **Summer 성능 저하**: RMSE 9.07, Bias -1.89. 강수 급변 대응 부족
4. **Peak 시간대 오차**: 10시 MAE=7.26 (Off-peak 대비 3.3배)

---

## 한계점

1. **Step-wise degradation**: 15 step을 하나의 hidden state에서 fc로 동시 추정 → 먼 step일수록 정보 손실. Step 14 MAE=11.29
2. **Summer 과대예측**: Bias -1.89. 강수량 급변(집중호우) 시 모델이 유량을 과대 추정
3. **Peak 시간대 한계**: 주간(06~22시) MAE=6.36으로 야간(3.96) 대비 60% 높음. 수요 급변 구간에서 정확도 저하
4. **단일 배수지 모델**: 배수지별 유량 특성(용량, 관로 구조)이 다르나 단일 모델로 학습
5. **Bias 방향 전환**: 과소(+2.13)에서 과대(-1.06)로 전환. 안정적인 0 수렴이 아닌 방향 진동

---

## 보완할 점

| 방법 | 기대 효과 | 우선순위 | 비고 |
|------|----------|----------|------|
| **Multi-Head Attention (Step-Query)** | Step 14 MAE 11.29 → 감소. 각 step별 독립 attention | **높음** | Step degradation 938% 해소 |
| **Bias 보정 (Val 잔차 기반)** | Bias -1.06 → 0 근처. 계절별 개별 보정 | **높음** | 후처리로 즉시 적용 가능 |
| **Peak 시간대 가중 학습** | Peak MAE 6.36 감소. loss function에 시간대 가중치 | 중간 | Weighted MSE Loss |
| **Summer 강수 강화 학습** | Summer Bias -1.89 개선. 강수 이벤트 oversampling | 중간 | Data augmentation |
| **hidden_size 증가 (128→256)** | 복잡한 패턴 학습 용량 확대 | 중간 | 파라미터 2배, 학습 시간 증가 |
| **배수지별 fine-tuning** | 배수지 특성 반영 | 낮음 | 기본 모델 안정화 후 진행 |

---

## 파이프라인 변경 이력

1. **LazyWindowDataset → TensorDataset**: CPU 사전 로드 방식으로 전환
2. **num_workers=0**: Python 3.14 forkserver 이슈로 DataLoader 워커 비활성화
3. **float32**: PyTorch 기본 타입 호환
4. **CPU 학습**: GTX 1050 Ti (sm_61) PyTorch 2.10 미지원 → `device = torch.device('cpu')`
5. **Seasonal Block Sampling (v3)**: 1년 순차 → 4계절 × 45일 블록 + 블록별 독립 split
6. **patience 조정 (v3)**: 7 → 5. v2 학습 분석 결과 불필요한 대기 제거
